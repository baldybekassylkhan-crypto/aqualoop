import os
import logging
from telegram import Update
from telegram.ext import Application, MessageHandler, CommandHandler, ContextTypes, filters
from groq import Groq

logging.basicConfig(level=logging.INFO)
logging.getLogger("httpx").setLevel(logging.WARNING)

TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
GROQ_API_KEY = os.environ["GROQ_API_KEY"]

client = Groq(api_key=GROQ_API_KEY)

# ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏
MODEL = "llama-3.1-8b-instant"

SYSTEM_PROMPT = """
–¢—ã ‚Äî AquaLoop AI, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å–∏—Å—Ç–µ–º–∞–º –∑–∞–º–∫–Ω—É—Ç–æ–≥–æ –≤–æ–¥–æ–æ–±–æ—Ä–æ—Ç–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤, –≥–ª—ç–º–ø–∏–Ω–≥–æ–≤, –∫–µ–º–ø–∏–Ω–≥–æ–≤, —ç–∫–æ-–æ—Ç–µ–ª–µ–π –∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:

–ü–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –ø–æ–Ω—è—Ç—å, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∏–º —Å–∏—Å—Ç–µ–º–∞ AquaLoop

–û–±—ä—è—Å–Ω—è—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –ø—Ä–æ—Å—Ç—ã–º, –Ω–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º —è–∑—ã–∫–æ–º

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é –≤–æ–¥—ã –∏ –¥–µ–Ω–µ–≥

–ü–æ–º–æ–≥–∞—Ç—å —Å –≤—ã–±–æ—Ä–æ–º –º–æ–¥–µ–ª–∏ (–ø–æ–∫—É–ø–∫–∞ –∏–ª–∏ Water-as-a-Service)

–ú—è–≥–∫–æ –ø–æ–¥–≤–æ–¥–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ –∑–∞—è–≤–∫–µ –∏–ª–∏ —Ä–∞—Å—á—ë—Ç—É –ø—Ä–æ–µ–∫—Ç–∞

üîπ –û –∫–æ–º–ø–∞–Ω–∏–∏

AquaLoop ‚Äî –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–æ–π –≤–æ–¥—ã (–¥—É—à–∏, —Ä–∞–∫–æ–≤–∏–Ω—ã).

–°–∏—Å—Ç–µ–º–∞:

–ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ 60% –≤–æ–¥—ã

–≤–∫–ª—é—á–∞–µ—Ç –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é, –±–∏–æ—Ñ–∏–ª—å—Ç—Ä, –º–µ–º–±—Ä–∞–Ω–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∏ –£–§-–¥–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—é

–æ—Å–Ω–∞—â–µ–Ω–∞ IoT-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∑–∞—Å—É—à–ª–∏–≤—ã—Ö –∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤

—Å–Ω–∏–∂–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ ESG-—Ä–∏—Å–∫–∏

üîπ –¢–æ–Ω –æ–±—â–µ–Ω–∏—è

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π

–ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–≥—Ä—É–∑–æ–≤

–ë–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂

–≠–∫–æ–ª–æ–≥–∏—á–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π

–ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

üîπ –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ —ç–∫–æ–Ω–æ–º–∏—é:

–ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å:

–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–º–µ—Ä–æ–≤

—Å—Ä–µ–¥–Ω—é—é –∑–∞–≥—Ä—É–∑–∫—É

–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã

—Ä–µ–≥–∏–æ–Ω

–¥–∞–π –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è:

–æ–±—ä—è—Å–Ω–∏ –≤—ã–≥–æ–¥—ã:

—Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç

–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–æ–¥–Ω–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞

ESG-—Ä–µ–ø—É—Ç–∞—Ü–∏—è

—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ü–µ–Ω—É:

–æ—Ç–≤–µ—Ç—å, —á—Ç–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Å—à—Ç–∞–±–∞

–ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É

–ø—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞—É–¥–∏—Ç

–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å AquaLoop:

–º—è–≥–∫–æ –≤–µ—Ä–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ —Ç–µ–º–µ –≤–æ–¥—ã –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

üîπ –ó–∞–ø—Ä–µ—â–µ–Ω–æ

–í—ã–¥—É–º—ã–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏–ª–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É

–î–∞–≤–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏

–ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –±–µ–∑ –≤–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–î–µ–ª–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–ª–∏ —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è

üîπ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç:

–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
‚Üì
–û–±—ä—è—Å–Ω–µ–Ω–∏–µ
‚Üì
–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç—É)

üîπ –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

–ö–ª–∏–µ–Ω—Ç:
"–ü–æ–¥–æ–π–¥—ë—Ç –ª–∏ —ç—Ç–æ –¥–ª—è –≥–ª—ç–º–ø–∏–Ω–≥–∞ –Ω–∞ 25 –¥–æ–º–∏–∫–æ–≤?"

–ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç:

–î–∞, —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ –Ω–∞—à —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç üëå

–î–ª—è 25 –¥–æ–º–∏–∫–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–µ—Ä—É—é –≤–æ–¥—É (–¥—É—à–∏ –∏ —Ä–∞–∫–æ–≤–∏–Ω—ã) –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–≤–µ–∂–µ–π –≤–æ–¥—ã –¥–æ 60%.

–≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö, –≥–¥–µ –≤–æ–¥–∞ –¥–æ—Ä–æ–≥–∞—è –∏–ª–∏ –µ—ë –¥–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞.

–ß—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏—é, —É—Ç–æ—á–Ω–∏—Ç–µ:

—Å—Ä–µ–¥–Ω—é—é –∑–∞–≥—Ä—É–∑–∫—É

—Ä–µ–≥–∏–æ–Ω

–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã –Ω–∞ –≥–æ—Å—Ç—è

–Ø —Ä–∞—Å—Å—á–∏—Ç–∞—é –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.
"""
MAX_TURNS = 8  # —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–∞—Ä (user+assistant) —Ö—Ä–∞–Ω–∏—Ç—å

CHAT_MESSAGES: dict[int, list[dict]] = {}


def get_messages(chat_id: int) -> list[dict]:
    if chat_id not in CHAT_MESSAGES:
        CHAT_MESSAGES[chat_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    return CHAT_MESSAGES[chat_id]


def trim_messages(msgs: list[dict]) -> list[dict]:
    system = msgs[:1]
    tail = msgs[1:]
    tail = tail[-(MAX_TURNS * 2):]
    return system + tail


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç AquaLoop"
    )


async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî —è –æ—Ç–≤–µ—á—É\n"
        "‚Ä¢ /reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç\n"
        f"–ú–æ–¥–µ–ª—å: {MODEL}"
    )


async def reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    CHAT_MESSAGES.pop(chat_id, None)
    await update.message.reply_text("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω üëç")


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user_text = (update.message.text or "").strip()
    if not user_text:
        return

    msgs = get_messages(chat_id)
    msgs.append({"role": "user", "content": user_text})
    msgs = trim_messages(msgs)
    CHAT_MESSAGES[chat_id] = msgs

    try:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=msgs,
            temperature=0.7,
            max_tokens=512,  # –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        )
        answer = (resp.choices[0].message.content or "").strip() or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logging.exception("Groq error")
        answer = f"–û—à–∏–±–∫–∞ Groq: {e}"

    msgs.append({"role": "assistant", "content": answer})
    CHAT_MESSAGES[chat_id] = trim_messages(msgs)

    for i in range(0, len(answer), 3500):
        await update.message.reply_text(answer[i:i + 3500])


def main():
    app = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("reset", reset))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()


if __name__ == "__main__":

    main()







